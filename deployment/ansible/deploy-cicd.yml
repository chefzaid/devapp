---
- name: Deploy CI/CD Infrastructure to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Deploy Jenkins
      command: kubectl apply -f ../k8s/jenkins.yaml
      register: jenkins_deploy
      changed_when: "'created' in jenkins_deploy.stdout or 'configured' in jenkins_deploy.stdout"

    - name: Deploy SonarQube
      command: kubectl apply -f ../k8s/sonarqube.yaml
      register: sonarqube_deploy
      changed_when: "'created' in sonarqube_deploy.stdout or 'configured' in sonarqube_deploy.stdout"

    - name: Deploy GitLab
      command: kubectl apply -f ../k8s/gitlab.yaml
      register: gitlab_deploy
      changed_when: "'created' in gitlab_deploy.stdout or 'configured' in gitlab_deploy.stdout"

    - name: Deploy Artifactory
      command: kubectl apply -f ../k8s/artifactory.yaml
      register: artifactory_deploy
      changed_when: "'created' in artifactory_deploy.stdout or 'configured' in artifactory_deploy.stdout"

    - name: Ensure ArgoCD Namespace Exists
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      register: argocd_ns_create
      changed_when: "'created' in argocd_ns_create.stdout"

    - name: Deploy ArgoCD
      command: kubectl apply -f ../k8s/argocd.yaml -n argocd
      register: argocd_deploy
      changed_when: "'created' in argocd_deploy.stdout or 'configured' in argocd_deploy.stdout"

    - name: Wait for Jenkins to be ready
      command: kubectl wait --for=condition=ready pod -l app=jenkins -n jenkins --timeout=300s
      ignore_errors: yes

    - name: Display Deployment Info
      debug:
        msg: |
          CI/CD Tools Deployed Successfully!

          jenkins:
            url: http://<node-ip>:30000
            agent-port: 30001
            initial-admin-password: kubectl exec -n jenkins -it deployment/jenkins -- cat /var/jenkins_home/secrets/initialAdminPassword

          sonarqube:
            url: http://<node-ip>:30002
            default-creds: admin/admin

          gitlab:
            url: http://<node-ip>:30080
            ssh-port: 30022
            root-password: kubectl get secret -n gitlab gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode

          artifactory:
            url: http://<node-ip>:30003
            default-creds: admin/password

          argocd:
            instructions: Port-forward the service (kubectl port-forward svc/argocd-server -n argocd 8080:443) or patch to NodePort.
            initial-admin-password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
