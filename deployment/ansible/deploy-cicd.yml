---
- name: Deploy CI/CD Infrastructure to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    infra_namespace: infrastructure

  tasks:
    - name: Deploy Jenkins
      command: kubectl apply -f ../k8s/jenkins.yaml
      register: jenkins_deploy
      changed_when: "'created' in jenkins_deploy.stdout or 'configured' in jenkins_deploy.stdout"

    - name: Configure Jenkins Nexus Settings
      command: kubectl apply -f ../k8s/jenkins-config.yaml
      register: jenkins_config
      changed_when: "'created' in jenkins_config.stdout or 'configured' in jenkins_config.stdout"

    - name: Deploy SonarQube
      command: kubectl apply -f ../k8s/sonarqube.yaml
      register: sonarqube_deploy
      changed_when: "'created' in sonarqube_deploy.stdout or 'configured' in sonarqube_deploy.stdout"

    - name: Deploy Nexus
      command: kubectl apply -f ../k8s/nexus.yaml
      register: nexus_deploy
      changed_when: "'created' in nexus_deploy.stdout or 'configured' in nexus_deploy.stdout"

    - name: Deploy ArgoCD Applications
      command: kubectl apply -f ../k8s/argocd-apps.yaml
      register: argocd_deploy
      changed_when: "'created' in argocd_deploy.stdout or 'configured' in argocd_deploy.stdout"

    - name: Wait for Jenkins to be ready
      command: kubectl wait --for=condition=ready pod -l app=jenkins -n {{ infra_namespace }} --timeout=300s
      ignore_errors: yes

    - name: Display Deployment Info
      debug:
        msg: |
          CI/CD Tools Deployed in '{{ infra_namespace }}' namespace!

          jenkins:       http://<node-ip>:30000 (agent: 30001)
          sonarqube:     http://<node-ip>:30002 (admin/admin)
          nexus:         http://<node-ip>:30005 (docker: 30006)
          argocd:        http://<node-ip>:30007
          grafana:       http://<node-ip>:30004 (admin/admin)
          prometheus:    http://<node-ip>:30003

          ArgoCD password: kubectl -n infrastructure get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
          Nexus password:  kubectl exec -n infrastructure deploy/nexus -- cat /nexus-data/admin.password
